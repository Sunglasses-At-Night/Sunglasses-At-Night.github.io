<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="0x00000000.dev">





<title>Alloy Entity Component System - Retrospective | 0x00000000 Blog</title>



    <link rel="icon" href="/favicon.ico">



<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.1.1"><style>
.dark-color-main {
    background-color: #121212;
}
</style><style>.no-js img.lazyload {
    display: none;
}img[data-sizes="auto"] {
    display: block;
    width: 100%;
}</style></head>

<body class="dark-color-main text-light">
    <br><br><br><br>
    <div class="wrapper">
        <header>
    <style>
        .navbar {
            /* position: fixed; */
            top: 0;
            width: 100%;
            height: 6%;
            padding-top: 0px;
            padding-bottom: 0px;
            background: #5755d9;
            z-index: 5;
            position: absolute;
        }

        @media screen and (min-width: 170px) {
            .navbar {
                display: flex;
            }

            .main {
                padding-top: 0pt;
            }
        }
    </style>
    <!-- NAV -->
    <header class="navbar">
        <section class="navbar-section">
            <!-- <div class="navbar-header header-logo"><a href="/">0x00000000 Blog</a></div> -->
        </section>
        <section class="navbar-center">
            <a class="btn btn-link text-light" href="/">Home</a>
            
                <a class="btn btn-link text-light" href="/archives">
                    Posts
                </a>
                
                <a class="btn btn-link text-light" href="/tags">
                    Tags
                </a>
                
        </section>
        <section class="navbar-section">
            <!-- <input id="switch_default" type="checkbox" class="switch_default"> -->
            <!-- <label for="switch_default" class="toggleBtn"></label> -->
        </section>
    </header>
</header>
<br><br>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.classList.contains("active")) {
            toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        } else {
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
        <article class="post-wrap columns">
            <style>
                .div-only-mobile {
                    display: none;
                }

                .div-no-mobile {
                    display: block;
                }

                @media screen and (max-width: 1280px) {
                    .div-no-mobile {
                        display: none
                    }

                    .div-only-mobile {
                        display: block;
                    }
                }

                ul {
                    list-style-position: outside;
                }

                ol ol, ol ul, ul ol, ul ul {
                    margin: 0 0 0 0;
                }

                .text-light {
                    color: #e8e8e8!important;
                }

            </style>
            <div class="column col-xl-2"></div>
            <div class="column col-8 col-xl-12">
                <header class="post-header">
                    <h1 class="post-title">
                        Alloy Entity Component System - Retrospective
                    </h1>
                    
                        <div class="post-meta">
                            
                                <a class="text-light">Author: </a><a class="text-gray">
                                        Calin Gavriliuc
                                    </a>
                                
                                    <br>
                                    
                                        <a class="text-light">Date: </a><a class="text-gray">
                                                November 15, 2021
                                            </a>
                                        
                                <br>
                                <a class="text-light">Views: <script>document.write('<img src="//counter.websiteout.net/compte.php?S='+encodeURI(window.location.href)+'&C=9&D=0&N=0&M=0" alt="" border="0"/>');</script></a>
                        </div>
                        
                </header>
                <div class="post-content">
                    <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h3 id="DeltaBlade-2700"><a href="#DeltaBlade-2700" class="headerlink" title="DeltaBlade 2700"></a>DeltaBlade 2700</h3><p>Internally called <em>Project SwitchBlade</em>, this project is a remake of the original DeltaBlade 2700 with Nintendo Switch support - hence the name ‘’SwitchBlade”. This project was taken on by team Handshake Firm while full-time college students. This team consists of ten programmers, myself included, and a sound designer.</p>
<p>The original game can be found here: <br><a target="_blank" rel="noopener" href="https://store.steampowered.com/app/1143450/DeltaBlade_2700/">DeltaBlade 2700</a> <br><noscript><img src="/images/TerrainGeneration/DeltaBlade2700.jpg" alt="DeltaBlade 2700"></noscript><img src="/images/LazyLoad.png" alt="DeltaBlade 2700" data-src="/images/TerrainGeneration/DeltaBlade2700.jpg" class="lazyload"></p>
<h3 id="Entity-Component-System"><a href="#Entity-Component-System" class="headerlink" title="Entity Component System"></a>Entity Component System</h3><p>An Entity Component System (ECS) is a programming paradigm often used in games for separating, often duplicate, logic.</p>
<p>While they come in many flavors, there are three main ideas to an ECS paradigm:</p>
<ul>
<li><strong>Entity</strong>: The parent or owner of a group of components. An Entity can be as simple as an ID, or as complex as a game object.</li>
<li><strong>Component</strong>: An attribute an entity can have. Can range from plain-old-data (POD) to complex behavior.</li>
<li><strong>System</strong>: A method of updating components, often called component systems for specificity.</li>
</ul>
<p>These three things give ECS its name.</p>
<p>For example, applying these concepts:</p>
<ul>
<li><strong>Want</strong>: A box in a game that is rendered and can collide.</li>
<li><strong>Entity</strong>: A box.</li>
<li><strong>Components</strong>: A Transform, Render, Collider, and Physics.</li>
<li><strong>Systems</strong>: One system for each component that updates that component each time step.</li>
</ul>
<p>Generally, an ECS will provide the following functionality:</p>
<ul>
<li>Ability to create/destroy an entity</li>
<li>Ability to add/remove/modify components to/from/on an entity</li>
<li>Ability to update components</li>
</ul>
<p>This concept is not new, and most popular game engines will use ECS in some form.</p>
<p>My implementation has been named <strong>Alloy</strong>. This library will generally be referred to as <em>Alloy</em> from this point on.</p>
<h2 id="Goals-amp-Restrictions"><a href="#Goals-amp-Restrictions" class="headerlink" title="Goals &amp; Restrictions"></a>Goals &amp; Restrictions</h2><h3 id="Goals"><a href="#Goals" class="headerlink" title="Goals"></a>Goals</h3><p>Alloy’s goals, in order:</p>
<ol>
<li><strong>Cross-Platform Support</strong>: Must support Windows, Nintendo Switch’s Horizon OS, Linux, Mac OS X, and more for development and release requirements.</li>
<li><strong>Update Loop Performance</strong>: The majority of the time will be spent updating components, so this should be optimized for.</li>
<li><strong>Usability &amp; Documentation</strong>: If nobody can / knows how to use Alloy, it might as well not exist.</li>
<li><strong>Utilities &amp; Tools &amp; Features</strong>: Quality of life additions and work improves usability, reduces mistakes, and assists with debugging.</li>
</ol>
<h3 id="Restrictions"><a href="#Restrictions" class="headerlink" title="Restrictions"></a>Restrictions</h3><p>As professor Dimitri Volper would say: “There is no free lunch.”</p>
<p>Essentially, “one-size-fits-all” does not exist. You must give something up to gain something.</p>
<p>The following was chosen to be sacrificed:</p>
<ul>
<li><strong>No component references</strong>: Due to backend performance reasons.</li>
<li><strong>A lack of extensive tools and utilities</strong>: Due to not using a public library and a lack of development time/needs.</li>
<li><strong>Secondary performance</strong>: Most of the library, Alloy, is blazing fast, but only at the expense of some features.</li>
<li><strong>Debugging</strong>: While partly available, complexity often balloons when performance improves.</li>
</ul>
<h2 id="Development-Process"><a href="#Development-Process" class="headerlink" title="Development Process"></a>Development Process</h2><h3 id="Research"><a href="#Research" class="headerlink" title="Research"></a>Research</h3><p>Starting, I began with exploring other ECS libraries, most notably <a target="_blank" rel="noopener" href="https://unity.com/dots">Unity DOTS</a> and <a target="_blank" rel="noopener" href="https://github.com/skypjack/entt">EnTT</a>. The former is an implementation I had experience working with, which the later was one my teammates had used before.</p>
<p>I also did much research on articles and blog posts about ECs, such as all thirteen parts of <a target="_blank" rel="noopener" href="https://skypjack.github.io/2019-02-14-ecs-baf-part-1/">ECS Back and Forth</a> and both <a target="_blank" rel="noopener" href="https://www.david-colson.com/2020/02/09/making-a-simple-ecs.html">How to make a simple entity-component-system in C++</a> and the <a target="_blank" rel="noopener" href="https://ajmmertens.medium.com/building-an-ecs-2-archetypes-and-vectorization-fe21690805f9">Building an ECS</a> series.</p>
<h3 id="Designing-and-Developing"><a href="#Designing-and-Developing" class="headerlink" title="Designing and Developing"></a>Designing and Developing</h3><p>Ultimately, I went with the design that was most in line with my goals. I designed Alloy to be an SoA Archetype-based ECS after testing other possible implementations.</p>
<p>During the development process, I used Clang Tidy, Clang’s address sanitization, <a target="_blank" rel="noopener" href="https://valgrind.org/">Valgrind</a>, and compiled with the LLVM Clang, GCC, and MSVC compilers, with warnings, to ensure a high-quality codebase.</p>
<h3 id="Testing-and-Debugging"><a href="#Testing-and-Debugging" class="headerlink" title="Testing and Debugging"></a>Testing and Debugging</h3><p>To ensure the quality of the library, a plethora of test cases and benchmarks were written. For validity, <a target="_blank" rel="noopener" href="https://github.com/google/googletest">Google Test</a> was used and, for consistency, <a target="_blank" rel="noopener" href="https://github.com/google/benchmark">Google Benchmark</a> was used.</p>
<p>The use of tests, paired with the use of this library in a game, allowed for me to solve many bugs and for Alloy to become stable. This also allowed me to further performance profile the library within real applications.</p>
<p>To profile Alloy, I used the Linux profiling tool <code>perf</code>, Microsoft Visual Studio’s Profiling and Diagnostics Tools, and <a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/vtune-profiler.html#gs.hfx933">Intel’s VTune Profiler</a>.</p>
<h2 id="Final-Achievements"><a href="#Final-Achievements" class="headerlink" title="Final Achievements"></a>Final Achievements</h2><h3 id="Alloy-Library"><a href="#Alloy-Library" class="headerlink" title="Alloy Library"></a>Alloy Library</h3><p>The following describes the layout of Alloy in memory:</p>
<p><noscript><img src="/images/AlloyECS/AlloyLayout.jpg" alt="Alloy Layout"></noscript><img src="/images/LazyLoad.png" alt="Alloy Layout" data-src="/images/AlloyECS/AlloyLayout.jpg" class="lazyload"></p>
<p>Alloy, despite being complex and performant, has a simple interface.</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Alloy/Alloy.h"</span></span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define a component</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Component</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">    <span class="keyword">int</span> var;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a space for an entity to live</span></span><br><span class="line">X::Space space{};</span><br><span class="line"><span class="comment">// Create a new entity</span></span><br><span class="line">X::Entity entity = space.CreateEntity();</span><br><span class="line"><span class="comment">// Give the entity a Component that is constructed with { 1 }</span></span><br><span class="line">space.EmplaceComponent&lt;Component&gt;(entity, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Update over all entities in the space that have Component</span></span><br><span class="line">space.Update&lt;Component&gt;([](X::Entity entity, Component&amp; component) {</span><br><span class="line">    <span class="comment">// Edit the component's values</span></span><br><span class="line">    ++component.var;</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove Component from the entity</span></span><br><span class="line">space.RemoveComponent&lt;Component&gt;(entity);</span><br><span class="line"><span class="comment">// Destroy the entity</span></span><br><span class="line">space.DestroyEntity(entity);</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h3><p>To fully tune and test Alloy, I compared it to a few popular c++ ECS libraries using a heavily modified version of <a target="_blank" rel="noopener" href="https://github.com/abeimler/ecs_benchmark">ECS Benchmark</a>.</p>
<p>As of Alloy v6:<br><noscript><img src="/images/AlloyECS/AlloyPerformance.png" alt="Alloy Performance"></noscript><img src="/images/LazyLoad.png" alt="Alloy Performance" data-src="/images/AlloyECS/AlloyPerformance.png" class="lazyload"></p>
<p><strong>Note</strong>: The data is color-coded on a scale of green to red, more performant to less performant, respectively.</p>
<p>At a glance, Alloy ECS is quite performant.<br>Due to the architecture chosen, Alloy is less-performant when creating/destroying entities or adding/removing components as the goal was update speed - which it dominates in.</p>
<h2 id="Hindsight"><a href="#Hindsight" class="headerlink" title="Hindsight"></a>Hindsight</h2><h3 id="Issues-amp-Mitigations"><a href="#Issues-amp-Mitigations" class="headerlink" title="Issues &amp; Mitigations"></a>Issues &amp; Mitigations</h3><p>As Michele Caini, known as <code>@skypjack</code> on GitHub and wrote the widely used EnTT, has said:</p>
<blockquote>
<p>I started developing <code>EnTT</code> for the wrong reason: my goal was to design an entity-component system to beat another well known open source solution both in terms of performance and possibly memory usage.</p>
</blockquote>
<p>Due to my choice of  goals and restrictions, issues came up during development:</p>
<ul>
<li><strong>Issue</strong>: POD / Aggregate Data / Blittable components only.<ul>
<li><strong>Mitigation</strong>: The ability for some more complex functionality was added, given:<ul>
<li>The component can be copied using an assignment operator, copy constructor, move constructor, or <code>memcpy</code> (preferred).</li>
<li>The component either does not need a destructor or implements one.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Issue</strong>: No component references can be stored.<ul>
<li><strong>Mitigation</strong>: As component lookup is O(1) (constant time), a <code>ComponentWrapper</code> was implemented that is a safer proxy for <code>GetComponentTemporary</code>.</li>
</ul>
</li>
<li><strong>Issue</strong>: Lack of debugging.<ul>
<li><strong>Mitigation</strong>: Unfortunately, not much could be done here. I personally dealt with as many issues myself as possible, but also developed tools - an entity viewer, component editor, etc - to help mitigate this.</li>
</ul>
</li>
</ul>
<h2 id="References-Future-Work-and-More"><a href="#References-Future-Work-and-More" class="headerlink" title="References, Future Work, and More"></a>References, Future Work, and More</h2><h3 id="Special-Thanks"><a href="#Special-Thanks" class="headerlink" title="Special Thanks"></a>Special Thanks</h3><p><strong>Jonathan Bourim</strong> for extensive help designing, implementing, testing, and debugging.</p>
<p><strong>Jordan Hoffmann</strong> for extensive testing and debugging.</p>
<p><strong><em>All</em> Members of team Handshake Firm</strong> for working with a non-standard ECS implementation and assisting with the development of Alloy.</p>
<h3 id="Future-Work"><a href="#Future-Work" class="headerlink" title="Future Work"></a>Future Work</h3><p>In the future, I would like to:</p>
<ul>
<li>Add <em>lots</em> of debugging support.</li>
<li>Add <em>lots</em> of utilities.</li>
<li>Write extensive documentation.</li>
<li>Compare memory consumption to other popular c++ ECS libraries.</li>
<li>Advanced update loop query filtering.</li>
<li>Vectorizing operations as batch requests.</li>
</ul>
<p>Other Research Areas:</p>
<ul>
<li>Sparse set implementation with paging.</li>
<li>Component hierarchies, groups, etc.</li>
<li>Building in a custom memory manager for better cache performance of operations.</li>
<li>Solving the issue of pointer invalidation many ECS libraries have.</li>
</ul>
<h3 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h3><p><a target="_blank" rel="noopener" href="https://store.steampowered.com/app/1143450/DeltaBlade_2700/">DeltaBlade 2700</a> : An Action-Packed Competitive Local Multiplayer Brawler with Explosive, Fast-Paced Sword Combat and Jetpacks.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/skypjack/entt">EnTT</a> : A feature-filled popular ECS library</p>
<p><a target="_blank" rel="noopener" href="https://unity.com/dots">Unity DOTS</a> : An archetype-based ECS implementation in C# for the Unity game engine.</p>
<p><a target="_blank" rel="noopener" href="https://flecs.docsforge.com/">Flecs</a> : An interesting implementation of an ECS system that allows for many non-standard paradigms.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apples/ginseng">Ginseng</a> : An ECS library that was designed to be used in games and for ease-of-use.</p>
<p><a target="_blank" rel="noopener" href="https://skypjack.github.io/2019-02-14-ecs-baf-part-1/">ECS Back and Forth</a> : A series of posts about implementing ECS.</p>
<p><a target="_blank" rel="noopener" href="https://www.david-colson.com/2020/02/09/making-a-simple-ecs.html">How to make a simple entity-component-system in C++</a> : Covers sparse sets and the logic behind using them. </p>
<p><a target="_blank" rel="noopener" href="https://ajmmertens.medium.com/building-an-ecs-2-archetypes-and-vectorization-fe21690805f9">Building an ECS</a> : Covers data packing and add/remove operation graph representation.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/abeimler/ecs_benchmark">ECS Benchmark</a> : For benchmarking the performance of popular c++ ECS libraries.</p>
<p><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/vtune-profiler.html#gs.hfx933">Intel’s VTune Profiler</a> : A very useful profiling tool to find bottlenecks and performance issues. </p>

                </div>
                
                        <section class="post-tags">
                            <div>
                                <span>Tag(s):</span>
                                <span class="tag">
                                    
                                        
                                            <a href="/tags/ECS/"># ECS</a>
                                            
                                            <a href="/tags/GameDev/"># GameDev</a>
                                            
                                                
                                </span>
                            </div>
                            <div>
                                <a href="javascript:window.history.back();">back</a>
                                <span>· </span>
                                <a href="/">home</a>
                            </div>
                        </section>
                        <section class="post-nav">
                            
                                    
                                        <a class="next" rel="next" href="/vulkan-retrospective/">
                                            Retrospective on Vulkan in DeltaBlade 2700
                                        </a>
                                        
                        </section>
            </div>
            <div class="column col-xl-2">
                
                    
                        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
                            
            </div>
        </article>
</div>
        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
<!-- © 0x00000000.dev |  -->
        <span>Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
    </div>
</footer>

    </div>


</body><script>!function(e,t){var r=function(){t(e.lazySizes),e.removeEventListener("lazyunveilread",r,!0)};t=t.bind(null,e,e.document),"object"==typeof module&&module.exports?t(require("lazysizes")):e.lazySizes?r():e.addEventListener("lazyunveilread",r,!0)}(window,function(u,a,d){"use strict";var i,n,s,l,t,r,p,o,c,f,m,y=d&&d.cfg,e=a.createElement("img"),g="sizes"in e&&"srcset"in e,h=/\s+\d+h/g,e=(n=/\s+(\d+)(w|h)\s+(\d+)(w|h)/,s=Array.prototype.forEach,function(){function r(e){var t,r=e.getAttribute(lazySizesConfig.srcsetAttr);r&&(t=r.match(n))&&((t="w"==t[2]?t[1]/t[3]:t[3]/t[1])&&e.setAttribute("data-aspectratio",t),e.setAttribute(lazySizesConfig.srcsetAttr,r.replace(h,"")))}function e(e){var t;e.detail.instance==d&&((t=e.target.parentNode)&&"PICTURE"==t.nodeName&&s.call(t.getElementsByTagName("source"),r),r(e.target))}function t(){i.currentSrc&&a.removeEventListener("lazybeforeunveil",e)}var i=a.createElement("img");a.addEventListener("lazybeforeunveil",e),i.onload=t,i.onerror=t,i.srcset="data:,a 1w 1h",i.complete&&t()});function z(e,t){return e.w-t.w}function v(e,t,r,i){l.push({c:t,u:r,w:+i})}function b(e,t){var r,i=e.getAttribute("srcset")||e.getAttribute(y.srcsetAttr);!i&&t&&(i=e._lazypolyfill?e._lazypolyfill._set:e.getAttribute(y.srcAttr)||e.getAttribute("src")),e._lazypolyfill&&e._lazypolyfill._set==i||(r=o(i||""),t&&e.parentNode&&(r.isPicture="PICTURE"==e.parentNode.nodeName.toUpperCase(),r.isPicture&&u.matchMedia&&(d.aC(e,"lazymatchmedia"),c())),r._set=i,Object.defineProperty(e,"_lazypolyfill",{value:r,writable:!0}))}function w(e){var t,r,i,a,n,s,l,o,c=e;if(b(c,!0),(a=c._lazypolyfill).isPicture)for(r=0,i=(t=e.parentNode.getElementsByTagName("source")).length;r<i;r++)if(y.supportsType(t[r].getAttribute("type"),e)&&f(t[r].getAttribute("media"))){c=t[r],b(c),a=c._lazypolyfill;break}return 1<a.length?(s=c.getAttribute("sizes")||"",s=p.test(s)&&parseInt(s,10)||d.gW(e,e.parentNode),a.d=(l=e,o=u.devicePixelRatio||1,l=d.getX&&d.getX(l),Math.min(l||o,2.5,o)),!a.src||!a.w||a.w<s?(a.w=s,n=function(e){for(var t,r,i=e.length,a=e[i-1],n=0;n<i;n++)if((a=e[n]).d=a.w/e.w,a.d>=e.d){!a.cached&&(t=e[n-1])&&t.d>e.d-.13*Math.pow(e.d,2.2)&&(r=Math.pow(t.d-.6,1.6),t.cached&&(t.d+=.15*r),t.d+(a.d-e.d)*r>e.d&&(a=t));break}return a}(a.sort(z)),a.src=n):n=a.src):n=a[0],n}function A(e){var t;g&&e.parentNode&&"PICTURE"!=e.parentNode.nodeName.toUpperCase()||(t=w(e))&&t.u&&e._lazypolyfill.cur!=t.u&&(e._lazypolyfill.cur=t.u,t.cached=!0,e.setAttribute(y.srcAttr,t.u),e.setAttribute("src",t.u))}y.supportsType||(y.supportsType=function(e){return!e}),u.HTMLPictureElement&&g?!d.hasHDescriptorFix&&a.msElementsFromPoint&&(d.hasHDescriptorFix=!0,e()):u.picturefill||y.pf||(y.pf=function(e){var t,r;if(!u.picturefill)for(t=0,r=e.elements.length;t<r;t++)i(e.elements[t])},p=/^\s*\d+\.*\d*px\s*$/,t=/(([^,\s].[^\s]+)\s+(\d+)w)/g,r=/\s/,c=function(){var e,r;function t(){for(var e=0,t=r.length;e<t;e++)i(r[e])}c.init||(c.init=!0,addEventListener("resize",(r=a.getElementsByClassName("lazymatchmedia"),function(){clearTimeout(e),e=setTimeout(t,66)})))},f=function(e){return u.matchMedia?(f=function(e){return!e||(matchMedia(e)||{}).matches})(e):!e},A.parse=o=function(e){return l=[],(e=e.trim()).replace(h,"").replace(t,v),l.length||!e||r.test(e)||l.push({c:e,u:e,w:99}),l},i=A,y.loadedClass&&y.loadingClass&&(m=[],['img[sizes$="px"][srcset].',"picture > img:not([srcset])."].forEach(function(e){m.push(e+y.loadedClass),m.push(e+y.loadingClass)}),y.pf({elements:a.querySelectorAll(m.join(", "))})))});</script><script>!function(e,t){t=t(e,e.document);e.lazySizes=t,"object"==typeof module&&module.exports&&(module.exports=t)}(window,function(a,m){"use strict";if(m.getElementsByClassName){var z,n,i,t,s,o,y=m.documentElement,r=a.Date,l=a.HTMLPictureElement,c="addEventListener",h="getAttribute",d=a[c],u=a.setTimeout,f=a.requestAnimationFrame||u,v=a.requestIdleCallback,g=/^picture$/i,p=["load","error","lazyincluded","_lazyloaded"],C={},b=Array.prototype.forEach,A=function(e,t){return C[t]||(C[t]=new RegExp("(\\s|^)"+t+"(\\s|$)")),C[t].test(e[h]("class")||"")&&C[t]},E=function(e,t){A(e,t)||e.setAttribute("class",(e[h]("class")||"").trim()+" "+t)},_=function(e,t){(t=A(e,t))&&e.setAttribute("class",(e[h]("class")||"").replace(t," "))},w=function(t,n,e){var a=e?c:"removeEventListener";e&&w(t,n),p.forEach(function(e){t[a](e,n)})},M=function(e,t,n,a,i){var s=m.createEvent("Event");return(n=n||{}).instance=ue,s.initEvent(t,!a,!i),s.detail=n,e.dispatchEvent(s),s},N=function(e,t){var n;!l&&(n=a.picturefill||z.pf)?(t&&t.src&&!e[h]("srcset")&&e.setAttribute("srcset",t.src),n({reevaluate:!0,elements:[e]})):t&&t.src&&(e.src=t.src)},x=function(e,t){return(getComputedStyle(e,null)||{})[t]},W=function(e,t,n){for(n=n||e.offsetWidth;n<z.minSize&&t&&!e._lazysizesWidth;)n=t.offsetWidth,t=t.parentNode;return n},T=(s=[],o=t=[],he._lsFlush=ye,he),e=function(n,e){return e?function(){T(n)}:function(){var e=this,t=arguments;T(function(){n.apply(e,t)})}},B=function(e){var t,n,a=function(){t=null,e()},i=function(){var e=r.now()-n;e<99?u(i,99-e):(v||a)(a)};return function(){n=r.now(),t=t||u(i,99)}};!function(){var e,t={lazyClass:"lazyload",loadedClass:"lazyloaded",loadingClass:"lazyloading",preloadClass:"lazypreload",errorClass:"lazyerror",autosizesClass:"lazyautosizes",srcAttr:"data-src",srcsetAttr:"data-srcset",sizesAttr:"data-sizes",minSize:40,customMedia:{},init:!0,expFactor:1.5,hFac:.8,loadMode:2,loadHidden:!0,ricTimeout:0,throttleDelay:125};for(e in z=a.lazySizesConfig||a.lazysizesConfig||{},t)e in z||(z[e]=t[e]);a.lazySizesConfig=z,u(function(){z.init&&ze()})}();var F,S,L,R,k,D,H,O,P,$,I,q,j,G,J,K,Q,U,V,X,Y,Z,ee,te,ne,ae,ie,se,oe,re,le,ce,de,ue,fe=(V=/^img$/i,X=/^iframe$/i,Y="onscroll"in a&&!/(gle|ing)bot/.test(navigator.userAgent),te=-1,j=pe,J=ee=Z=0,K=z.throttleDelay,Q=z.ricTimeout,U=v&&49<Q?function(){v(Ce,{timeout:Q}),Q!==z.ricTimeout&&(Q=z.ricTimeout)}:e(function(){u(Ce)},!0),ae=e(be),ie=function(e){ae({target:e.target})},se=e(function(t,e,n,a,i){var s,o,r,l;(r=M(t,"lazybeforeunveil",e)).defaultPrevented||(a&&(n?E(t,z.autosizesClass):t.setAttribute("sizes",a)),n=t[h](z.srcsetAttr),a=t[h](z.srcAttr),i&&(o=(s=t.parentNode)&&g.test(s.nodeName||"")),l=e.firesLoad||"src"in t&&(n||a||o),r={target:t},E(t,z.loadingClass),l&&(clearTimeout(L),L=u(ve,2500),w(t,ie,!0)),o&&b.call(s.getElementsByTagName("source"),Ae),n?t.setAttribute("srcset",n):a&&!o&&(X.test(t.nodeName)?function(t,n){try{t.contentWindow.location.replace(n)}catch(e){t.src=n}}(t,a):t.src=a),i&&(n||o)&&N(t,{src:a})),t._lazyRace&&delete t._lazyRace,_(t,z.lazyClass),T(function(){var e=t.complete&&1<t.naturalWidth;l&&!e||(e&&E(t,"ls-is-cached"),be(r),t._lazyCache=!0,u(function(){"_lazyCache"in t&&delete t._lazyCache},9))},!0)}),re=function(){var e;S||(r.now()-k<999?u(re,999):(e=B(function(){z.loadMode=3,ne()}),S=!0,z.loadMode=3,ne(),d("scroll",function(){3==z.loadMode&&(z.loadMode=2),e()},!0)))},{_:function(){k=r.now(),ue.elements=m.getElementsByClassName(z.lazyClass),F=m.getElementsByClassName(z.lazyClass+" "+z.preloadClass),d("scroll",ne,!0),d("resize",ne,!0),a.MutationObserver?new MutationObserver(ne).observe(y,{childList:!0,subtree:!0,attributes:!0}):(y[c]("DOMNodeInserted",ne,!0),y[c]("DOMAttrModified",ne,!0),setInterval(ne,999)),d("hashchange",ne,!0),["focus","mouseover","click","load","transitionend","animationend","webkitAnimationEnd"].forEach(function(e){m[c](e,ne,!0)}),/d$|^c/.test(m.readyState)?re():(d("load",re),m[c]("DOMContentLoaded",ne),u(re,2e4)),ue.elements.length?(pe(),T._lsFlush()):ne()},checkElems:ne=function(e){var t;(e=!0===e)&&(Q=33),G||(G=!0,(t=K-(r.now()-J))<0&&(t=0),e||t<9?U():u(U,t))},unveil:oe=function(e){var t,n=V.test(e.nodeName),a=n&&(e[h](z.sizesAttr)||e[h]("sizes")),i="auto"==a;(!i&&S||!n||!e[h]("src")&&!e.srcset||e.complete||A(e,z.errorClass)||!A(e,z.lazyClass))&&(t=M(e,"lazyunveilread").detail,i&&me.updateElem(e,!0,e.offsetWidth),e._lazyRace=!0,ee++,se(e,t,i,a,n))}}),me=(ce=e(function(e,t,n,a){var i,s,o;if(e._lazysizesWidth=a,e.setAttribute("sizes",a+="px"),g.test(t.nodeName||""))for(s=0,o=(i=t.getElementsByTagName("source")).length;s<o;s++)i[s].setAttribute("sizes",a);n.detail.dataAttr||N(e,n.detail)}),{_:function(){le=m.getElementsByClassName(z.autosizesClass),d("resize",de)},checkElems:de=B(function(){var e,t=le.length;if(t)for(e=0;e<t;e++)Ee(le[e])}),updateElem:Ee}),ze=function(){ze.i||(ze.i=!0,me._(),fe._())};return ue={cfg:z,autoSizer:me,loader:fe,init:ze,uP:N,aC:E,rC:_,hC:A,fire:M,gW:W,rAF:T}}function ye(){var e=o;for(o=t.length?s:t,i=!(n=!0);e.length;)e.shift()();n=!1}function he(e,t){n&&!t?e.apply(this,arguments):(o.push(e),i||(i=!0,(m.hidden?u:f)(ye)))}function ve(e){ee--,e&&!(ee<0)&&e.target||(ee=0)}function ge(e){return(q=null==q?"hidden"==x(m.body,"visibility"):q)||"hidden"!=x(e.parentNode,"visibility")&&"hidden"!=x(e,"visibility")}function pe(){var e,t,n,a,i,s,o,r,l,c,d,u,f=ue.elements;if((R=z.loadMode)&&ee<8&&(e=f.length)){for(t=0,te++,c=!z.expand||z.expand<1?500<y.clientHeight&&500<y.clientWidth?500:370:z.expand,d=(ue._defEx=c)*z.expFactor,u=z.hFac,q=null,Z<d&&ee<1&&2<te&&2<R&&!m.hidden?(Z=d,te=0):Z=1<R&&1<te&&ee<6?c:0;t<e;t++)if(f[t]&&!f[t]._lazyRace)if(Y)if(l!==(s=!(r=f[t][h]("data-expand"))||!(s=+r)?Z:s)&&(D=innerWidth+s*u,H=innerHeight+s,o=-1*s,l=s),n=f[t].getBoundingClientRect(),(I=n.bottom)>=o&&(O=n.top)<=H&&($=n.right)>=o*u&&(P=n.left)<=D&&(I||$||P||O)&&(z.loadHidden||ge(f[t]))&&(S&&ee<3&&!r&&(R<3||te<4)||function(e,t){var n,a=e,i=ge(e);for(O-=t,I+=t,P-=t,$+=t;i&&(a=a.offsetParent)&&a!=m.body&&a!=y;)(i=0<(x(a,"opacity")||1))&&"visible"!=x(a,"overflow")&&(n=a.getBoundingClientRect(),i=$>n.left&&P<n.right&&I>n.top-1&&O<n.bottom+1);return i}(f[t],s))){if(oe(f[t]),i=!0,9<ee)break}else!i&&S&&!a&&ee<4&&te<4&&2<R&&(F[0]||z.preloadAfterLoad)&&(F[0]||!r&&(I||$||P||O||"auto"!=f[t][h](z.sizesAttr)))&&(a=F[0]||f[t]);else oe(f[t]);a&&!i&&oe(a)}}function Ce(){G=!1,J=r.now(),j()}function be(e){var t=e.target;t._lazyCache?delete t._lazyCache:(ve(e),E(t,z.loadedClass),_(t,z.loadingClass),w(t,ie),M(t,"lazyloaded"))}function Ae(e){var t,n=e[h](z.srcsetAttr);(t=z.customMedia[e[h]("data-media")||e[h]("media")])&&e.setAttribute("media",t),n&&e.setAttribute("srcset",n)}function Ee(e,t,n){var a=e.parentNode;a&&(n=W(e,a,n),(t=M(e,"lazybeforesizes",{width:n,dataAttr:!!t})).defaultPrevented||(n=t.detail.width)&&n!==e._lazysizesWidth&&ce(e,a,t,n))}});lazySizes.init();</script></html>