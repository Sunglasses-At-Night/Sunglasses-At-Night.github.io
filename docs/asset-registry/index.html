<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="0x00000000.dev">





<title>Implementing An Asset Registry | 0x00000000 Blog</title>



    <link rel="icon" href="/favicon.ico">



<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.1.1"><style>
.dark-color-main {
    background-color: #121212;
}
</style><style>.no-js img.lazyload {
    display: none;
}img[data-sizes="auto"] {
    display: block;
    width: 100%;
}</style></head>

<body class="dark-color-main text-light">
    <br><br><br><br>
    <div class="wrapper">
        <header>
    <style>
        .navbar {
            /* position: fixed; */
            top: 0;
            width: 100%;
            height: 6%;
            padding-top: 0px;
            padding-bottom: 0px;
            background: #5755d9;
            z-index: 5;
            position: absolute;
        }

        @media screen and (min-width: 170px) {
            .navbar {
                display: flex;
            }

            .main {
                padding-top: 0pt;
            }
        }
    </style>
    <!-- NAV -->
    <header class="navbar">
        <section class="navbar-section">
            <!-- <div class="navbar-header header-logo"><a href="/">0x00000000 Blog</a></div> -->
        </section>
        <section class="navbar-center">
            <a class="btn btn-link text-light" href="/">Home</a>
            
                <a class="btn btn-link text-light" href="/archives">
                    Posts
                </a>
                
                <a class="btn btn-link text-light" href="/tags">
                    Tags
                </a>
                
        </section>
        <section class="navbar-section">
            <!-- <input id="switch_default" type="checkbox" class="switch_default"> -->
            <!-- <label for="switch_default" class="toggleBtn"></label> -->
        </section>
    </header>
</header>
<br><br>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.classList.contains("active")) {
            toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        } else {
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
        <article class="post-wrap columns">
            <style>
                .div-only-mobile {
                    display: none;
                }

                .div-no-mobile {
                    display: block;
                }

                @media screen and (max-width: 1280px) {
                    .div-no-mobile {
                        display: none
                    }

                    .div-only-mobile {
                        display: block;
                    }
                }

                ul {
                    list-style-position: outside;
                }

                ol ol, ol ul, ul ol, ul ul {
                    margin: 0 0 0 0;
                }

                .text-light {
                    color: #e8e8e8!important;
                }

            </style>
            <div class="column col-xl-2"></div>
            <div class="column col-8 col-xl-12">
                <header class="post-header">
                    <h1 class="post-title">
                        Implementing An Asset Registry
                    </h1>
                    
                        <div class="post-meta">
                            
                                <a class="text-light">Author: </a><a class="text-gray">
                                        Jordan Hoffmann
                                    </a>
                                
                                    <br>
                                    
                                        <a class="text-light">Date: </a><a class="text-gray">
                                                October 17, 2021
                                            </a>
                                        
                                <br>
                                <a class="text-light">Views: <script>document.write('<img src="//counter.websiteout.net/compte.php?S='+encodeURI(window.location.href)+'&C=9&D=0&N=0&M=0" alt="" border="0"/>');</script></a>
                        </div>
                        
                </header>
                <div class="post-content">
                    <h2 id="Motive"><a href="#Motive" class="headerlink" title="Motive"></a>Motive</h2><p>If you’ve worked on a project without an asset registry, you’ve likely come across the following scenario: An asset is used in 6 places and it’s path is hard-coded in all 6. On it’s own, this isn’t that big of a deal. Much like magic numbers, it will never pose a problem until you need to change them. At that point, however, you’ll be stuck desperately trying to find and replace and hoping you don’t cause collateral damage. This problem becomes exponentially more frequent if you have artists on your team. If you do, your asset names will quickly go from <code>frog.png</code> to <code>frog_green.png</code> to <code>frog_green_new.png</code> to <code>frog_green_new_revised_final_last_draft.png</code>. As a result, it becomes necessary that the asset names in your code, are abstracted away from the literal filenames in the OS filesystem.</p>
<hr>
<h2 id="Design-Goals"><a href="#Design-Goals" class="headerlink" title="Design Goals"></a>Design Goals</h2><p>The AssetRegistry exists to achieve the following system design goals:</p>
<ol>
<li>Serve as an added layer of abstraction above file paths<ul>
<li>enable easier asset directory refactors</li>
<li>enable separated Asset and SaveData</li>
</ul>
</li>
<li>Provide an OS-agnostic interface<ul>
<li>support for Windows 64, Linux, and Horizon operating systems</li>
</ul>
</li>
<li>Encourage the use of <a href="#Abstraction-Level-3-Packages">Packages</a> as a method to store relevant <a href="bstraction-Level-2-Assets">Assets</a> as a collection where they’re used most often</li>
<li>Encourage the use of <a href="#Abstraction-Level-2-Assets">Assets</a> as a method to <a href="#Additional-Feature-2-Asset-and-Package-inheritance">handle how file data is read, saved, and managed</a> within the engine</li>
<li>Keep files from being reread unnecessarily by storing their data in ram</li>
</ol>
<hr>
<h2 id="Abstractions"><a href="#Abstractions" class="headerlink" title="Abstractions"></a>Abstractions</h2><p>The following sub-sections are organized in layers of abstraction. I’ll start with the most basic way to manage directories and each additional subsection will extend the functionality until we have a final product that meets all our <a href="#Design-Goals">design goals</a>.</p>
<h3 id="Abstraction-Level-1-INI-file"><a href="#Abstraction-Level-1-INI-file" class="headerlink" title="Abstraction Level 1: INI file"></a>Abstraction Level 1: INI file</h3><p>In an effort to address <a href="#Design-Goals">design goal 1</a>, we can reference all assets by name and store the dictionary between name and path inside a separate file. This would look something like this:</p>
<p><code>ini file:</code></p>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">frog_texture</span> = <span class="string">"Assets/Images/Frog/frog_green.png"</span></span><br><span class="line"><span class="attr">bat_texture</span> = <span class="string">"Assets/Images/Bat/bat_texture_new.png"</span></span><br><span class="line"></span><br><span class="line">...etc...</span><br></pre></td></tr></tbody></table></figure>

<p><code>c++ code:</code></p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; Assets;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitAssetRegistry</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    INIFile ini = INILoad(<span class="string">"AssetRegistry.ini"</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> <span class="keyword">auto</span> &amp;asset : ini)</span><br><span class="line">    {</span><br><span class="line">        Assets[asset.key] = asset.value;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DoFroggyStuff</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    FILE* frog_img = fopen(Assets[<span class="string">"frog_img"</span>]);</span><br><span class="line">    Render(frog_img);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Pros"><a href="#Pros" class="headerlink" title="Pros"></a>Pros</h4><ol>
<li>Very easy. Provided you either write a basic ini parser or use an external library, you can have this method working in no time.</li>
<li>When files are renamed or moved, you only need to modify the ini file</li>
</ol>
<h3 id="Abstraction-Level-2-Assets"><a href="#Abstraction-Level-2-Assets" class="headerlink" title="Abstraction Level 2: Assets"></a>Abstraction Level 2: Assets</h3><p>Ideally Asset should be a c++ class. This way they can be extended in the future and can have more functionality than simple strings. for now we’ll just make it a glorified <code>std::string</code> that stores the OS file path.</p>
<h4 id="Pros-1"><a href="#Pros-1" class="headerlink" title="Pros"></a>Pros</h4><ol>
<li>If implemented effectively, assets can be modified relatively easily in the future</li>
<li>starts work towards <a href="#Design-Goals">design goal 4</a></li>
<li>starts work towards <a href="#Design-Goals">design goal 5</a></li>
</ol>
<h3 id="Abstraction-Level-3-Packages"><a href="#Abstraction-Level-3-Packages" class="headerlink" title="Abstraction Level 3: Packages"></a>Abstraction Level 3: Packages</h3><p>to address <a href="#Design-Goals">design goal 3</a>, let’s create an object - call it <code>Package</code> - that stores a dictionary of assets. this way users can organize their assets in a meaningful way.</p>
<p>in order to achieve this, we need to reflect the concept of packages in the ini file. For this we can use section headers:</p>
<figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Textures]</span></span><br><span class="line"><span class="attr">frog</span> = <span class="string">"Assets/Images/Frog/frog_green.png"</span></span><br><span class="line"><span class="attr">bat</span> = <span class="string">"Assets/Images/Bat/bat_texture_new.png"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Levels]</span></span><br><span class="line"><span class="attr">level1</span> = <span class="string">"Assets/level1.txt"</span></span><br><span class="line"><span class="attr">level2</span> = <span class="string">"Assets/level2.txt"</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="Pros-2"><a href="#Pros-2" class="headerlink" title="Pros"></a>Pros</h4><ol>
<li>If implemented effectively, packages can be modified relatively easily in the future</li>
<li>names can be reused across packages.</li>
<li>package names can give hints to their content’s type so names like <code>frog_texture</code> can be reduced to <code>frog</code> in the package <code>textures</code></li>
</ol>
<h3 id="Abstraction-Level-4-Asset-Registry-System"><a href="#Abstraction-Level-4-Asset-Registry-System" class="headerlink" title="Abstraction Level 4: Asset Registry System"></a>Abstraction Level 4: Asset Registry System</h3><p>If you were to implement all of the above abstractions with no changes, you’d end up with a Package class, an Asset class, and no where to store their instances. Abstraction Level 1 proposed the use of an unordered_map, but making this public and global would be unwise. There’d be no way to control how it’s used and no way to switch it out with a different data structure. This abstraction level implements an Asset Registry namespace or singleton that provides the following interface.</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LoadRegistry</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SaveRegistry</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">std</span>::weak_ptr&lt;PackageType&gt; <span class="title">GetPackage</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; packageName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> PackageType = Package&gt;</span><br><span class="line"><span class="built_in">std</span>::weak_ptr&lt;PackageType&gt; CreatePackage(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; packageName);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">RemovePackage</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; packageName)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">PackageCount</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Pros-3"><a href="#Pros-3" class="headerlink" title="Pros"></a>Pros</h4><ol>
<li>If implemented effectively, the back end can be modified relatively easily in the future</li>
<li>the interface gives hints to the user how it’s meant to be used reducing the need for excessive documentation</li>
<li>any OS specific operations can be performed privately and the interface is maintained across the board. This fully meets <a href="#Design-Goals">design goal 2</a></li>
</ol>
<h2 id="Additional-Features"><a href="#Additional-Features" class="headerlink" title="Additional Features"></a>Additional Features</h2><p>Now that we’ve built a full abstraction model, let’s try to address some of the remaining issues by adding more features</p>
<h3 id="Additional-Feature-1-sub-packages"><a href="#Additional-Feature-1-sub-packages" class="headerlink" title="Additional Feature 1: sub-packages"></a>Additional Feature 1: sub-packages</h3><p>If you simply make packages capable of also storing references to other packages, they can act very similar to symbolic directories. Here’s how that might look in the INI</p>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ClassicMode]</span></span><br><span class="line">SubPackage:Environment = _ClassicEnvironment</span><br><span class="line">SubPackage:Player = _ClassicPlayer</span><br><span class="line"></span><br><span class="line"><span class="section">[_ClassicEnvironment]</span></span><br><span class="line">SubPackage:Textures = _ClassicEnvironmentTextures</span><br><span class="line"></span><br><span class="line"><span class="section">[_ClassicEnvironmentTextures]</span></span><br><span class="line">Asset:Background = Assets/Game/Textures/Background/Background.png</span><br><span class="line">Asset:Boarder = Assets/Game/Textures/Background/Boarder.png</span><br><span class="line">Asset:BrokenCeiling = Assets/Game/Textures/Background/broken_ceiling.png</span><br><span class="line">Asset:DepthMap = Assets/Game/Textures/Background/FlippedDepthMap.png</span><br><span class="line">Asset:Tilemap = Assets/Game/Textures/Tilemap/tile_full_16_metal.png</span><br><span class="line">SubPackage:Particles = _ClassicEnvironmentParticles</span><br><span class="line"></span><br><span class="line"><span class="section">[_ClassicEnvironmentParticles]</span></span><br><span class="line">Asset:RainDrop = Assets/Game/Textures/Particles/rain_drop.png</span><br><span class="line">Asset:RainSplash = Assets/Game/Textures/Particles/rain_splash.png</span><br><span class="line">Asset:Fog = Assets/Game/Textures/Particles/fog.png</span><br><span class="line">Asset:Rocks = Assets/Game/Textures/Particles/rock_bits.png</span><br><span class="line"></span><br><span class="line">...etc...</span><br></pre></td></tr></tbody></table></figure>
<p>Using a flat format like this allows multiple packages to reference the same sub-package without having duplicate data. That way you can organize the data in multiple ways at the same time and use the organization that works best for the use case</p>
<blockquote>
<p>Note: this is no longer a syntactically correct ini file because it uses both ‘:’ and ‘=’. <a target="_blank" rel="noopener" href="https://github.com/pulzed/mINI">The library I’m using</a> allows this but you may need to represent your data differently if you’re using a different ini parser</p>
</blockquote>
<h3 id="Additional-Feature-2-Asset-and-Package-inheritance"><a href="#Additional-Feature-2-Asset-and-Package-inheritance" class="headerlink" title="Additional Feature 2: Asset and Package inheritance"></a>Additional Feature 2: Asset and Package inheritance</h3><p>A big limitation we still have in the proposed system is that assets are still just file paths and there’s no way to extend them to de-serialize the data properly and provide relevant methods. for example, an exe asset would ideally have a “Execute” method and a sprite asset would ideally store it’s render data in ram after it’s loaded. Thankfully c++ provides us with inheritance to solve this. We simply need to make our getters templates that cast to the requested type:</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> PackageType = Package&gt;</span><br><span class="line"><span class="built_in">std</span>::weak_ptr&lt;PackageType&gt; GetPackage(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; packageName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> AssetType = Asset&gt;</span><br><span class="line"><span class="built_in">std</span>::weak_ptr&lt;AssetType&gt; GetAsset(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; assetName);</span><br></pre></td></tr></tbody></table></figure>

<p>For the DeltaBlade engine, we decided that real time type reflection was overkill so the assets are all stored internally as <code>std::shared_ptr&lt;Asset&gt;</code>s and are simply replaced with the extended type when <code>GetAsset</code> is called. With proper runtime type reflection however, you could choose to serialize the type inside the ini file and then load the correct type at startup. This would allow for assets to be preloaded easier without having to know the type externally.</p>
<h3 id="Additional-Feature-3-Registry-Paths"><a href="#Additional-Feature-3-Registry-Paths" class="headerlink" title="Additional Feature 3: Registry Paths"></a>Additional Feature 3: Registry Paths</h3><p>The Asset Registry introduces a concept known as Registry Paths. Similar to filesystem paths, this is a way to represent a series of packages, and sub-packages opened in order to retrieve an asset as a colon delineated string. if for example, your AssetRegistry.ini file looks something like this:</p>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[UI]</span></span><br><span class="line">SubPackage:Textures = _UITextures</span><br><span class="line">SubPackage:Audio = _GAME_UI_Audio</span><br><span class="line"></span><br><span class="line"><span class="section">[_UITextures]</span></span><br><span class="line">Asset:MenuButton = Assets/Game/UI/Menu/button.png</span><br><span class="line">Asset:MenuBackground = Assets/Game/UI/Menu/background.png</span><br><span class="line"></span><br><span class="line"><span class="section">[_GAME_UI_Audio]</span></span><br><span class="line">Asset:MenuMusic = Assets/Game/Audio/menu_music.wav</span><br><span class="line">Asset:MenuButtonClick = Assets/Game/Audio/sfs/click.wav</span><br></pre></td></tr></tbody></table></figure>

<p>then retrieving the menu music could be done in any of the following ways:</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// opening packages individually</span></span><br><span class="line">PackageHandle UI = AssetRegistry::GetPackageChecked(<span class="string">"UI"</span>).lock();</span><br><span class="line">PackageHandle UIAudio = UI-&gt;GetSubPackageChecked(<span class="string">"Audio"</span>).lock();</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;AMusic&gt; MenuMusic = UIAudio-&gt;GetAssetChecked&lt;AMusic&gt;(<span class="string">"MenuMusic"</span>).lock();</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// using registry paths</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;AMusic&gt; MenuMusic = AssetRegistry::GetAssetChecked&lt;AMusic&gt;(<span class="string">"UI:Audio:MenuMusic"</span>).lock();</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// using a hybrid</span></span><br><span class="line">PackageHandle UIAudio = AssetRegistry::GetPackageChecked(<span class="string">"UI:Audio"</span>).lock();</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;AMusic&gt; MenuMusic = UIAudio-&gt;GetAssetChecked&lt;AMusic&gt;(<span class="string">"MenuMusic"</span>).lock();</span><br></pre></td></tr></tbody></table></figure>

<p>This feature is purely syntactical but it speeds up development significantly and keeps packages from being a burden to use</p>
<h3 id="Additional-Feature-4-Editor"><a href="#Additional-Feature-4-Editor" class="headerlink" title="Additional Feature 4: Editor"></a>Additional Feature 4: Editor</h3><p>You’ve officially made it to the fun part. This is where the pretty pictures and gifs live! When developing the registry it became quickly apparent that the ini was going to blow up and become increasingly difficult to parse. To solve this, I wanted to allow users to modify it in a better environment than a text editor. Using ImGui I made the following tree based editor</p>
<p><noscript><img src="/images/AssetRegistry/Editor.png" alt="Asset Registry Editor"></noscript><img src="/images/LazyLoad.png" alt="Asset Registry Editor" data-src="/images/AssetRegistry/Editor.png" class="lazyload"></p>
<p>As you can see, when changes are made in the editor, they’re saved to the ini in real time.</p>
<p><noscript><img src="/images/AssetRegistry/Editor.gif" alt="Asset Registry Editor"></noscript><img src="/images/LazyLoad.png" alt="Asset Registry Editor" data-src="/images/AssetRegistry/Editor.gif" class="lazyload"></p>
<p>The editor supports</p>
<ul>
<li>viewing the contents of packages</li>
<li>adding packages, sub-packages, or assets</li>
<li>removing packages, sub-packages or assets</li>
<li>copying the OS path of assets to the clipboard</li>
<li>copying the <a href="#Additional-Feature-3-Registry-Paths">registry path</a> of assets and packages to the clipboard</li>
<li>copying the name of assets and packages to the clipboard</li>
</ul>
<h3 id="Additional-Feature-5-Error-Handling-Modals"><a href="#Additional-Feature-5-Error-Handling-Modals" class="headerlink" title="Additional Feature 5: Error Handling Modals"></a>Additional Feature 5: Error Handling Modals</h3><p>I could’ve called this project complete at this point. I’d met all the <a href="#Design-Goals">design goals</a>, made a great editor, and provided several ways to access, read, and modify the data. What’s important to remember however, is that I’m implementing this for humans. And humans are known for two things:</p>
<ol>
<li>They’re lazy. They don’t want to use a system if it’s not stupid easy</li>
<li>They’re prone to mistakes. Even if they <em>know</em> not to rename files without modifying the ini, they’re probably going to forget at some point.</li>
</ol>
<p>all decent systems have some form of error logging but all great systems can completely resolve the errors without crashing. I’m of course striving for greatness. Let’s consider the worst case scenario:</p>
<blockquote>
<p>A user renames a core file such as a default shader from ‘Assets/Game/Shaders/forwardVert.glsl’ to ‘Assets/Game/Shaders/forwardVert_Renamed.glsl’ and forgets to modify the ini</p>
</blockquote>
<p>With the proposed system, the game would crash immediately. The best we could do is return nullptr or throw an exception and hope it’s caught but realistically, what could the renderer possibly do? It can’t render anything without a shader and there’s no way for the renderer to find it.</p>
<p>Instead, I have the registry ask the user and wait for their response. To do this, I had to create a completely separate application and launch it from the editor when there’s a problem. This application simply walks the user through fixing their error and quietly resumes as if nothing happened</p>
<p><noscript><img src="/images/AssetRegistry/Modals.gif" alt="Asset Registry Modals"></noscript><img src="/images/LazyLoad.png" alt="Asset Registry Modals" data-src="/images/AssetRegistry/Modals.gif" class="lazyload"></p>
<p>The following errors are handled in this way:</p>
<ul>
<li>A package was requested in code, but it’s not in the AssetRegistry</li>
<li>An Asset was requested in code but it’s not in the AssetRegistry</li>
<li>A sub-package was requested in code, but it’s not in the AssetRegistry</li>
<li>An Asset was renamed but the ini wasn’t modified to reflect the edit</li>
<li>An Asset was moved but the ini wasn’t modified to reflect the edit</li>
</ul>
<p>This feature becomes particularly powerful when you stop thinking of it as error handling, and instead think of it as a part of the pipeline. The previous pipeline was as follows:</p>
<ol>
<li>put file inside Assets directory</li>
<li>modify ini file (either directly or by launching the editor and modifying it there)</li>
<li>write code that uses the asset</li>
</ol>
<p>but this isn’t how most devs like to work. If you’re like me, you’d much rather write the code first. After all, we want packages to reflect <em>how</em> the assets are used and that might not be clear until the code is written. By intentionally expecting an error from the registry though, we can write the code first and let the error handler do the rest:</p>
<ol>
<li>put file inside the Assets directory</li>
<li>write code that uses the asset - making up names for the asset and it’s package(s) on the spot</li>
<li>launch the editor and get an error that the name doesn’t exist</li>
<li>link the asset using the modal</li>
<li>continue testing the game/editor as normal</li>
</ol>
<hr>
<h2 id="Post-Mortem"><a href="#Post-Mortem" class="headerlink" title="Post Mortem"></a>Post Mortem</h2><p>TODO: I’ll write my post mortem after at the end of the semester after we’ve used the asset registry more</p>
<hr>
<h2 id="Useful-Resources"><a href="#Useful-Resources" class="headerlink" title="Useful Resources"></a>Useful Resources</h2><p>Simple Ini parsing library: <a target="_blank" rel="noopener" href="https://github.com/pulzed/mINI">mIni</a></p>
<p>Basic, cross platform ImGui interface that I used for the modals: <a target="_blank" rel="noopener" href="https://github.com/pthom/hello_imgui">Hello, Dear ImGui</a></p>
<p>How Unreal Engine handles assets: <a target="_blank" rel="noopener" href="https://docs.unrealengine.com/4.27/en-US/ProductionPipelines/AssetManagement/">docs.unrealengine.com</a></p>

                </div>
                
                        <section class="post-tags">
                            <div>
                                <span>Tag(s):</span>
                                <span class="tag">
                                    
                                        
                                            <a href="/tags/GameDev/"># GameDev</a>
                                            
                                            <a href="/tags/DeltaBlade2700/"># DeltaBlade2700</a>
                                            
                                            <a href="/tags/Engine/"># Engine</a>
                                            
                                            <a href="/tags/Core/"># Core</a>
                                            
                                                
                                </span>
                            </div>
                            <div>
                                <a href="javascript:window.history.back();">back</a>
                                <span>· </span>
                                <a href="/">home</a>
                            </div>
                        </section>
                        <section class="post-nav">
                            
                                    
                                        <a class="next" rel="next" href="/why_mvc/">
                                            Why MVC?
                                        </a>
                                        
                        </section>
            </div>
            <div class="column col-xl-2">
                
                    
                        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
                            
            </div>
        </article>
</div>
        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
<!-- © 0x00000000.dev |  -->
        <span>Powered by <a href="https://hexo.io" target="_blank">Hexo</a></span>
    </div>
</footer>

    </div>


</body><script>!function(e,t){var r=function(){t(e.lazySizes),e.removeEventListener("lazyunveilread",r,!0)};t=t.bind(null,e,e.document),"object"==typeof module&&module.exports?t(require("lazysizes")):e.lazySizes?r():e.addEventListener("lazyunveilread",r,!0)}(window,function(u,a,d){"use strict";var i,n,s,l,t,r,p,o,c,f,m,y=d&&d.cfg,e=a.createElement("img"),g="sizes"in e&&"srcset"in e,h=/\s+\d+h/g,e=(n=/\s+(\d+)(w|h)\s+(\d+)(w|h)/,s=Array.prototype.forEach,function(){function r(e){var t,r=e.getAttribute(lazySizesConfig.srcsetAttr);r&&(t=r.match(n))&&((t="w"==t[2]?t[1]/t[3]:t[3]/t[1])&&e.setAttribute("data-aspectratio",t),e.setAttribute(lazySizesConfig.srcsetAttr,r.replace(h,"")))}function e(e){var t;e.detail.instance==d&&((t=e.target.parentNode)&&"PICTURE"==t.nodeName&&s.call(t.getElementsByTagName("source"),r),r(e.target))}function t(){i.currentSrc&&a.removeEventListener("lazybeforeunveil",e)}var i=a.createElement("img");a.addEventListener("lazybeforeunveil",e),i.onload=t,i.onerror=t,i.srcset="data:,a 1w 1h",i.complete&&t()});function z(e,t){return e.w-t.w}function v(e,t,r,i){l.push({c:t,u:r,w:+i})}function b(e,t){var r,i=e.getAttribute("srcset")||e.getAttribute(y.srcsetAttr);!i&&t&&(i=e._lazypolyfill?e._lazypolyfill._set:e.getAttribute(y.srcAttr)||e.getAttribute("src")),e._lazypolyfill&&e._lazypolyfill._set==i||(r=o(i||""),t&&e.parentNode&&(r.isPicture="PICTURE"==e.parentNode.nodeName.toUpperCase(),r.isPicture&&u.matchMedia&&(d.aC(e,"lazymatchmedia"),c())),r._set=i,Object.defineProperty(e,"_lazypolyfill",{value:r,writable:!0}))}function w(e){var t,r,i,a,n,s,l,o,c=e;if(b(c,!0),(a=c._lazypolyfill).isPicture)for(r=0,i=(t=e.parentNode.getElementsByTagName("source")).length;r<i;r++)if(y.supportsType(t[r].getAttribute("type"),e)&&f(t[r].getAttribute("media"))){c=t[r],b(c),a=c._lazypolyfill;break}return 1<a.length?(s=c.getAttribute("sizes")||"",s=p.test(s)&&parseInt(s,10)||d.gW(e,e.parentNode),a.d=(l=e,o=u.devicePixelRatio||1,l=d.getX&&d.getX(l),Math.min(l||o,2.5,o)),!a.src||!a.w||a.w<s?(a.w=s,n=function(e){for(var t,r,i=e.length,a=e[i-1],n=0;n<i;n++)if((a=e[n]).d=a.w/e.w,a.d>=e.d){!a.cached&&(t=e[n-1])&&t.d>e.d-.13*Math.pow(e.d,2.2)&&(r=Math.pow(t.d-.6,1.6),t.cached&&(t.d+=.15*r),t.d+(a.d-e.d)*r>e.d&&(a=t));break}return a}(a.sort(z)),a.src=n):n=a.src):n=a[0],n}function A(e){var t;g&&e.parentNode&&"PICTURE"!=e.parentNode.nodeName.toUpperCase()||(t=w(e))&&t.u&&e._lazypolyfill.cur!=t.u&&(e._lazypolyfill.cur=t.u,t.cached=!0,e.setAttribute(y.srcAttr,t.u),e.setAttribute("src",t.u))}y.supportsType||(y.supportsType=function(e){return!e}),u.HTMLPictureElement&&g?!d.hasHDescriptorFix&&a.msElementsFromPoint&&(d.hasHDescriptorFix=!0,e()):u.picturefill||y.pf||(y.pf=function(e){var t,r;if(!u.picturefill)for(t=0,r=e.elements.length;t<r;t++)i(e.elements[t])},p=/^\s*\d+\.*\d*px\s*$/,t=/(([^,\s].[^\s]+)\s+(\d+)w)/g,r=/\s/,c=function(){var e,r;function t(){for(var e=0,t=r.length;e<t;e++)i(r[e])}c.init||(c.init=!0,addEventListener("resize",(r=a.getElementsByClassName("lazymatchmedia"),function(){clearTimeout(e),e=setTimeout(t,66)})))},f=function(e){return u.matchMedia?(f=function(e){return!e||(matchMedia(e)||{}).matches})(e):!e},A.parse=o=function(e){return l=[],(e=e.trim()).replace(h,"").replace(t,v),l.length||!e||r.test(e)||l.push({c:e,u:e,w:99}),l},i=A,y.loadedClass&&y.loadingClass&&(m=[],['img[sizes$="px"][srcset].',"picture > img:not([srcset])."].forEach(function(e){m.push(e+y.loadedClass),m.push(e+y.loadingClass)}),y.pf({elements:a.querySelectorAll(m.join(", "))})))});</script><script>!function(e,t){t=t(e,e.document);e.lazySizes=t,"object"==typeof module&&module.exports&&(module.exports=t)}(window,function(a,m){"use strict";if(m.getElementsByClassName){var z,n,i,t,s,o,y=m.documentElement,r=a.Date,l=a.HTMLPictureElement,c="addEventListener",h="getAttribute",d=a[c],u=a.setTimeout,f=a.requestAnimationFrame||u,v=a.requestIdleCallback,g=/^picture$/i,p=["load","error","lazyincluded","_lazyloaded"],C={},b=Array.prototype.forEach,A=function(e,t){return C[t]||(C[t]=new RegExp("(\\s|^)"+t+"(\\s|$)")),C[t].test(e[h]("class")||"")&&C[t]},E=function(e,t){A(e,t)||e.setAttribute("class",(e[h]("class")||"").trim()+" "+t)},_=function(e,t){(t=A(e,t))&&e.setAttribute("class",(e[h]("class")||"").replace(t," "))},w=function(t,n,e){var a=e?c:"removeEventListener";e&&w(t,n),p.forEach(function(e){t[a](e,n)})},M=function(e,t,n,a,i){var s=m.createEvent("Event");return(n=n||{}).instance=ue,s.initEvent(t,!a,!i),s.detail=n,e.dispatchEvent(s),s},N=function(e,t){var n;!l&&(n=a.picturefill||z.pf)?(t&&t.src&&!e[h]("srcset")&&e.setAttribute("srcset",t.src),n({reevaluate:!0,elements:[e]})):t&&t.src&&(e.src=t.src)},x=function(e,t){return(getComputedStyle(e,null)||{})[t]},W=function(e,t,n){for(n=n||e.offsetWidth;n<z.minSize&&t&&!e._lazysizesWidth;)n=t.offsetWidth,t=t.parentNode;return n},T=(s=[],o=t=[],he._lsFlush=ye,he),e=function(n,e){return e?function(){T(n)}:function(){var e=this,t=arguments;T(function(){n.apply(e,t)})}},B=function(e){var t,n,a=function(){t=null,e()},i=function(){var e=r.now()-n;e<99?u(i,99-e):(v||a)(a)};return function(){n=r.now(),t=t||u(i,99)}};!function(){var e,t={lazyClass:"lazyload",loadedClass:"lazyloaded",loadingClass:"lazyloading",preloadClass:"lazypreload",errorClass:"lazyerror",autosizesClass:"lazyautosizes",srcAttr:"data-src",srcsetAttr:"data-srcset",sizesAttr:"data-sizes",minSize:40,customMedia:{},init:!0,expFactor:1.5,hFac:.8,loadMode:2,loadHidden:!0,ricTimeout:0,throttleDelay:125};for(e in z=a.lazySizesConfig||a.lazysizesConfig||{},t)e in z||(z[e]=t[e]);a.lazySizesConfig=z,u(function(){z.init&&ze()})}();var F,S,L,R,k,D,H,O,P,$,I,q,j,G,J,K,Q,U,V,X,Y,Z,ee,te,ne,ae,ie,se,oe,re,le,ce,de,ue,fe=(V=/^img$/i,X=/^iframe$/i,Y="onscroll"in a&&!/(gle|ing)bot/.test(navigator.userAgent),te=-1,j=pe,J=ee=Z=0,K=z.throttleDelay,Q=z.ricTimeout,U=v&&49<Q?function(){v(Ce,{timeout:Q}),Q!==z.ricTimeout&&(Q=z.ricTimeout)}:e(function(){u(Ce)},!0),ae=e(be),ie=function(e){ae({target:e.target})},se=e(function(t,e,n,a,i){var s,o,r,l;(r=M(t,"lazybeforeunveil",e)).defaultPrevented||(a&&(n?E(t,z.autosizesClass):t.setAttribute("sizes",a)),n=t[h](z.srcsetAttr),a=t[h](z.srcAttr),i&&(o=(s=t.parentNode)&&g.test(s.nodeName||"")),l=e.firesLoad||"src"in t&&(n||a||o),r={target:t},E(t,z.loadingClass),l&&(clearTimeout(L),L=u(ve,2500),w(t,ie,!0)),o&&b.call(s.getElementsByTagName("source"),Ae),n?t.setAttribute("srcset",n):a&&!o&&(X.test(t.nodeName)?function(t,n){try{t.contentWindow.location.replace(n)}catch(e){t.src=n}}(t,a):t.src=a),i&&(n||o)&&N(t,{src:a})),t._lazyRace&&delete t._lazyRace,_(t,z.lazyClass),T(function(){var e=t.complete&&1<t.naturalWidth;l&&!e||(e&&E(t,"ls-is-cached"),be(r),t._lazyCache=!0,u(function(){"_lazyCache"in t&&delete t._lazyCache},9))},!0)}),re=function(){var e;S||(r.now()-k<999?u(re,999):(e=B(function(){z.loadMode=3,ne()}),S=!0,z.loadMode=3,ne(),d("scroll",function(){3==z.loadMode&&(z.loadMode=2),e()},!0)))},{_:function(){k=r.now(),ue.elements=m.getElementsByClassName(z.lazyClass),F=m.getElementsByClassName(z.lazyClass+" "+z.preloadClass),d("scroll",ne,!0),d("resize",ne,!0),a.MutationObserver?new MutationObserver(ne).observe(y,{childList:!0,subtree:!0,attributes:!0}):(y[c]("DOMNodeInserted",ne,!0),y[c]("DOMAttrModified",ne,!0),setInterval(ne,999)),d("hashchange",ne,!0),["focus","mouseover","click","load","transitionend","animationend","webkitAnimationEnd"].forEach(function(e){m[c](e,ne,!0)}),/d$|^c/.test(m.readyState)?re():(d("load",re),m[c]("DOMContentLoaded",ne),u(re,2e4)),ue.elements.length?(pe(),T._lsFlush()):ne()},checkElems:ne=function(e){var t;(e=!0===e)&&(Q=33),G||(G=!0,(t=K-(r.now()-J))<0&&(t=0),e||t<9?U():u(U,t))},unveil:oe=function(e){var t,n=V.test(e.nodeName),a=n&&(e[h](z.sizesAttr)||e[h]("sizes")),i="auto"==a;(!i&&S||!n||!e[h]("src")&&!e.srcset||e.complete||A(e,z.errorClass)||!A(e,z.lazyClass))&&(t=M(e,"lazyunveilread").detail,i&&me.updateElem(e,!0,e.offsetWidth),e._lazyRace=!0,ee++,se(e,t,i,a,n))}}),me=(ce=e(function(e,t,n,a){var i,s,o;if(e._lazysizesWidth=a,e.setAttribute("sizes",a+="px"),g.test(t.nodeName||""))for(s=0,o=(i=t.getElementsByTagName("source")).length;s<o;s++)i[s].setAttribute("sizes",a);n.detail.dataAttr||N(e,n.detail)}),{_:function(){le=m.getElementsByClassName(z.autosizesClass),d("resize",de)},checkElems:de=B(function(){var e,t=le.length;if(t)for(e=0;e<t;e++)Ee(le[e])}),updateElem:Ee}),ze=function(){ze.i||(ze.i=!0,me._(),fe._())};return ue={cfg:z,autoSizer:me,loader:fe,init:ze,uP:N,aC:E,rC:_,hC:A,fire:M,gW:W,rAF:T}}function ye(){var e=o;for(o=t.length?s:t,i=!(n=!0);e.length;)e.shift()();n=!1}function he(e,t){n&&!t?e.apply(this,arguments):(o.push(e),i||(i=!0,(m.hidden?u:f)(ye)))}function ve(e){ee--,e&&!(ee<0)&&e.target||(ee=0)}function ge(e){return(q=null==q?"hidden"==x(m.body,"visibility"):q)||"hidden"!=x(e.parentNode,"visibility")&&"hidden"!=x(e,"visibility")}function pe(){var e,t,n,a,i,s,o,r,l,c,d,u,f=ue.elements;if((R=z.loadMode)&&ee<8&&(e=f.length)){for(t=0,te++,c=!z.expand||z.expand<1?500<y.clientHeight&&500<y.clientWidth?500:370:z.expand,d=(ue._defEx=c)*z.expFactor,u=z.hFac,q=null,Z<d&&ee<1&&2<te&&2<R&&!m.hidden?(Z=d,te=0):Z=1<R&&1<te&&ee<6?c:0;t<e;t++)if(f[t]&&!f[t]._lazyRace)if(Y)if(l!==(s=!(r=f[t][h]("data-expand"))||!(s=+r)?Z:s)&&(D=innerWidth+s*u,H=innerHeight+s,o=-1*s,l=s),n=f[t].getBoundingClientRect(),(I=n.bottom)>=o&&(O=n.top)<=H&&($=n.right)>=o*u&&(P=n.left)<=D&&(I||$||P||O)&&(z.loadHidden||ge(f[t]))&&(S&&ee<3&&!r&&(R<3||te<4)||function(e,t){var n,a=e,i=ge(e);for(O-=t,I+=t,P-=t,$+=t;i&&(a=a.offsetParent)&&a!=m.body&&a!=y;)(i=0<(x(a,"opacity")||1))&&"visible"!=x(a,"overflow")&&(n=a.getBoundingClientRect(),i=$>n.left&&P<n.right&&I>n.top-1&&O<n.bottom+1);return i}(f[t],s))){if(oe(f[t]),i=!0,9<ee)break}else!i&&S&&!a&&ee<4&&te<4&&2<R&&(F[0]||z.preloadAfterLoad)&&(F[0]||!r&&(I||$||P||O||"auto"!=f[t][h](z.sizesAttr)))&&(a=F[0]||f[t]);else oe(f[t]);a&&!i&&oe(a)}}function Ce(){G=!1,J=r.now(),j()}function be(e){var t=e.target;t._lazyCache?delete t._lazyCache:(ve(e),E(t,z.loadedClass),_(t,z.loadingClass),w(t,ie),M(t,"lazyloaded"))}function Ae(e){var t,n=e[h](z.srcsetAttr);(t=z.customMedia[e[h]("data-media")||e[h]("media")])&&e.setAttribute("media",t),n&&e.setAttribute("srcset",n)}function Ee(e,t,n){var a=e.parentNode;a&&(n=W(e,a,n),(t=M(e,"lazybeforesizes",{width:n,dataAttr:!!t})).defaultPrevented||(n=t.detail.width)&&n!==e._lazysizesWidth&&ce(e,a,t,n))}});lazySizes.init();</script></html>